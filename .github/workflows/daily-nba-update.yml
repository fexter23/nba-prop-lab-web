import os
import time
import pandas as pd
from datetime import datetime
from nba_api.stats.static import players
from nba_api.stats.endpoints import leaguedashplayerstats

# 1. Season Helper
def get_current_season():
    today = datetime.today()
    if today.month >= 10:
        return f"{today.year}-{str(today.year + 1)[-2:]}"
    else:
        return f"{today.year-1}-{str(today.year)[-2:]}"

CURRENT_SEASON = get_current_season()
print(f"Starting NBA data update â€” {datetime.now().strftime('%Y-%m-%d %H:%M UTC')}")

# 2. Save Static Player List
all_players = players.get_players()
df_players = pd.DataFrame(all_players)
os.makedirs("data", exist_ok=True)
df_players.to_parquet("data/players.parquet", index=False)
print(f"Saved {len(df_players)} players")

# 3. Fetch Active Teams (League-wide)
team_map = {}
custom_headers = {
    'Host': 'stats.nba.com',
    'User-Agent': 'Mozilla/5.0',
    'Referer': 'https://stats.nba.com/'
}

try:
    print(f"Fetching data for {CURRENT_SEASON}...")
    df = leaguedashplayerstats.LeagueDashPlayerStats(
        season=CURRENT_SEASON,
        season_type_all_star="Regular Season",
        headers=custom_headers,
        timeout=30
    ).get_data_frames()[0]
    
    if not df.empty:
        df = df[df['TEAM_ABBREVIATION'].notna() & (df['TEAM_ABBREVIATION'] != '')]
        team_map = dict(zip(df['PLAYER_ID'].astype(str), df['TEAM_ABBREVIATION']))
        print(f"Successfully got {len(team_map)} active players")
except Exception as e:
    print(f"Failed to fetch: {e}")

if team_map:
    df_teams = pd.DataFrame.from_dict(team_map, orient='index', columns=['TEAM_ABBR'])
    df_teams.index.name = 'PLAYER_ID'
    df_teams.reset_index(inplace=True)
    df_teams.to_parquet("data/active_player_teams.parquet", index=False)

print("Update finished.")
