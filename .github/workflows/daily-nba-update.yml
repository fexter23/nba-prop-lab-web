# scripts/update_nba_data.py
from nba_api.stats.static import players
from nba_api.stats.endpoints import leaguedashplayerstats
import pandas as pd
import os
import time
from datetime import datetime

# Use the logic from your nba_wrk.py for consistency
def get_current_season():
    today = datetime.today()
    if today.month >= 10:
        return f"{today.year}-{str(today.year + 1)[-2:]}"
    else:
        return f"{today.year-1}-{str(today.year)[-2:]}"

CURRENT_SEASON = get_current_season()
current_year = int(CURRENT_SEASON.split('-')[0])
PREVIOUS_SEASON = f"{current_year - 1}-{str(current_year)[-2:]}"

print(f"Starting NBA data update â€” {datetime.now().strftime('%Y-%m-%d %H:%M UTC')}")

# 1. Save All Players
all_players = players.get_players()
df_players = pd.DataFrame(all_players)
os.makedirs("data", exist_ok=True)
df_players.to_parquet("data/players.parquet", index=False)
print(f"Saved {len(df_players)} players")

# 2. Fetch Active Players and Teams
team_map = {}
seasons = [CURRENT_SEASON, PREVIOUS_SEASON] 

# Recommended headers to avoid API blocks
custom_headers = {
    'Host': 'stats.nba.com',
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
    'Accept': 'application/json, text/plain, */*',
    'Accept-Language': 'en-US,en;q=0.5',
    'Referer': 'https://stats.nba.com/',
    'Connection': 'keep-alive'
}

for season in seasons:
    try:
        print(f"Attempting to fetch data for {season}...")
        df = leaguedashplayerstats.LeagueDashPlayerStats(
            season=season,
            season_type_all_star="Regular Season",
            headers=custom_headers,
            timeout=30
        ).get_data_frames()[0]
        
        if not df.empty and len(df) > 80:
            df = df[df['TEAM_ABBREVIATION'].notna() & (df['TEAM_ABBREVIATION'] != '')]
            team_map = dict(zip(df['PLAYER_ID'].astype(str), df['TEAM_ABBREVIATION']))
            print(f"Successfully got {len(team_map)} active players from {season}")
            break
    except Exception as e:
        print(f"Season {season} failed: {e}")
        time.sleep(2) 

if team_map:
    df_teams = pd.DataFrame.from_dict(team_map, orient='index', columns=['TEAM_ABBR'])
    df_teams.index.name = 'PLAYER_ID'
    df_teams.reset_index(inplace=True)
    df_teams.to_parquet("data/active_player_teams.parquet", index=False)
    print("Active player teams saved.")
else:
    print("Warning: No active team data retrieved")

print("Update finished.")
